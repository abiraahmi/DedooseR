---
title: "Cleaning, Merging, and Exploring Qualitative Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Cleaning, Merging, and Exploring Qualitative Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Qualitative projects rarely begin with a dataset that is ready for analysis and
raw Dedoose exports do not include a dedicated ID column. Instead, they arrive
with transcript metadata, coder names, ranges, weights, and one column per code.
This vignette walks through a typical workflow—cleaning excerpts, merging related
codes, and reviewing the underlying text—using three core functions:
`clean_data()`, `merge_codes()`, and `view_excerpts()`. The mock tibble above
mirrors that structure so the entire vignette can render without private files.

```{r setup}
library(DedooseR)
library(tibble)

# Mock excerpts that mimic a Dedoose export ----------------------------------
demo_excerpts <- tribble(
  ~`Media Title`, ~`Excerpt Range`, ~`Excerpt Creator`, ~`Excerpt Date`,
  ~`Excerpt Copy`, ~`Resource Creator`, ~`Resource Date`,
  ~`Codes Applied Combined`,
  ~`Code: Sense of Belonging & Connectedness Applied`,
  ~`Code: Sense of Belonging & Connectedness Range`,
  ~`Code: Sense of Belonging & Connectedness Weight`,
  ~`Code: Sense of Belonging & Connectedness\\Peers Applied`,
  ~`Code: Sense of Belonging & Connectedness\\Peers Range`,
  ~`Code: Sense of Belonging & Connectedness\\Peers Weight`,
  ~`Code: Long-term Impact Applied`,
  ~`Code: Long-term Impact Range`,
  ~`Code: Long-term Impact Weight`,
  "Interview: Program Launch", "Excerpt 12-56", "Aliyah", as.Date("2023-04-12"),
    "I finally felt like I belonged with my friends and in my school.",
    "Staff Team", as.Date("2023-04-01"),
    "Sense of Belonging & Connectedness",
    "True", "1-2", 1,
    "True", "1-1", 1,
    "False", NA_character_, NA_real_,
  "Focus Group: Summer Session", "Excerpt 04-38", "Rohan", as.Date("2023-07-28"),
    "Staff kept checking in, so staying engaged over summer felt easier.",
    "Evaluation Lead", as.Date("2023-07-15"),
    "Sense of Belonging & Connectedness; Long-term Impact",
    "False", NA_character_, NA_real_,
    "True", "2-3", 2,
    "True", "2-2", 2,
  "Interview: Alumni Reflections", "Excerpt 77-112", "Aliyah", as.Date("2024-01-08"),
    "That mentorship still shapes the goals I set for myself.",
    "Alumni Coordinator", as.Date("2023-12-20"),
    "Long-term Impact",
    "False", NA_character_, NA_real_,
    "False", NA_character_, NA_real_,
    "True", "4-5", 3
)

demo_excerpts
```


## 1. Clean excerpts with `clean_data()`

The `clean_data()` function standardizes column names, keeps the highest ranked
coder per transcript, drops range/weight columns, prefixes code variables with
`c_`, and returns both the cleaned data and a codebook. Supply the mock data along
with your preferred coder order. You can optionally rename and relabel variables
at the same time.

```{r}
preferred_coders <- c("Aliyah", "Rohan")

cleaned <- clean_data(
  excerpts = demo_excerpts,
  preferred_coders = preferred_coders,
  rename_vars = list(resource_author = "resource_creator"),
  relabel_vars = list(
    media_title = "Interview or focus group title",
    resource_author = "Team member who uploaded to Dedoose"
  )
)

cleaned$data
```

Reviewing the codebook that ships with the cleaned data helps confirm variable
labels and types before moving on.

```{r}
cleaned$codebook
```

## 2. Merge related codes with `merge_codes()`

When multiple codes capture the same idea, `merge_codes()` combines them into a
single logical column and updates the codebook. Here, the general belonging code
and its peers sub-code are collapsed into one composite while the remaining codes
stay as-is.

```{r}
merged <- merge_codes(
  data = cleaned$data,
  merges = list(
    c_belonging_connectedness = c(
      "c_sense_of_belonging_connectedness",
      "c_sense_of_belonging_connectedness_peers"
    )
  ),
  relabel_vars = list(
    c_belonging_connectedness = "Belonging or connectedness mentioned"
  )
)

merged$data_merged
```

```{r}
merged$codebook_merged
```

## 3. Explore excerpts with `view_excerpts()`

Finally, surface the excerpts behind each code. `view_excerpts()` opens an
interactive table powered by `DT`, letting you filter by code and search within
text. To keep vignette builds stable, the chunk only runs when `DT` is
available.

```{r}
if (requireNamespace("DT", quietly = TRUE)) {
  view_excerpts(merged$data_merged)
} else {
  message("Install the DT package to launch the interactive excerpt browser.")
}
```

Replace `demo_excerpts` with your actual export when it is ready—the workflow
remains the same. Start with `clean_data()` to standardize everything, merge or
retire codes as your analysis evolves, and lean on `view_excerpts()` whenever
you want to reconnect with the qualitative stories behind the summaries.
